$schema: 'https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json'
information_for_contributors:
  - >-
    To modify Perl Moose Textmate grammar you mus edit the file
    src/syntaxes/perl-moose.tmLanguage.yaml then, run following
    command to generate extension source code.
  - npm run generate:syntax

fileTypes: []
injectionSelector: source.perl
name: Perl Moose
patterns:
  - include: '#perl_moose_role'
  - include: '#perl_moose'

repository:
  # This section contains Moose related syntax
  perl_moose:
    comment: >- 
      We look for 'use Moose' sentence to add grammar additions
      Moose scope ends when 'no Moose' or 'package' is matched
    name: meta.moose.perl
    begin: (?<=use)\s+(Moose|Moo)[\s;]
    beginCaptures:
      '1':
        name: entity.name.class.moose.perl
    end: (\b)(?=^\s*package\s|no\s+\1$\s)
    patterns:
      - include: '#moose'
      - include: 'source.perl'
  moose:
    patterns:
      - match: \b(-meta_name)\b
        captures:
          '1':
            name: entity.other.attribute-name.moose.perl
        name: constant.language.type.modifier.moose.perl
      - match: \b(extends|with)(?:\s+([-a-zA-Z0-9_]+))?\s*
        captures:
          '1':
            name: keyword.control.import.moose.perl
          '2':
            name: entity.name.class.moose.perl
        name: keyword.control.moose.perl
      - match: \b(has)(?:\s+(\+|)([-a-zA-Z0-9_]+))?\s*
        captures:
          '1':
            name:  keyword.other.attribute.moose.perl
          '2':
            name: storage.modifier.attribute.moose.perl
          '3':
            name: entity.other.attribute-name.moose.perl
      - match: \b(is|isa|coerce|does|required|weak_ref|lazy|trigger|handles|traits|builder|default|clearer|predicate|documentation|auto_deref|lazy_build|role_attribute)\s*(?==>)
        name: constant.language.has.key.moose.perl        
      - match: \b(before|after|around|override|augment)(?:\s+([-a-zA-Z0-9_]+))?
        captures:
          '1':
            name: keyword.other.attribute.moose.perl
          '2':
            name: entity.name.function.perl
      - match: \b(meta|super|inner|blessed|confess)\b
        name:  support.function.moose.perl

  # This section contains Moose::Role related syntax
  perl_moose_role:
    comment: >- 
      We look for 'use Moose::Role' sentence to add grammar additions
      Moose scope ends when 'no Moose::Role' or 'package' is matched
    name: meta.role.moose.perl
    begin: (?<=use)\s+((?:Moose|Moo)::Role)[\s;]
    beginCaptures:
      '1':
        name: entity.name.class.moose.perl
    end: (\b)(?=^\s*package\s|no\s+\1$\s)
    patterns:
      - include: '#moose_role'
      - include: 'source.perl'
  moose_role:
    name: meta.role.moose.perl
    patterns:
      - name: constant.language.type.modifier.moose.perl
        match: \b(-traits)\s*(?==>)
      - name: keyword.other.role.moose.perl
        match: \b(requires|excludes)\b
      - include: '#moose'

scopeName: source.moose.perl
