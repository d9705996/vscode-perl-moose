sudo: false
dist: xenial
language: node_js
node_js: "11.0.0"
stages:
  - test
  - release
  - test package

jobs:
  include:
    - stage: test
      name: "Test VSCode Extension"
      install: npm install
      before_script: npm run build
      script: xvfb-run npm test --silent

    - &release
      stage: release
      name: "Publish GitHub Release"
      if: tag =~ /^v?[0-9]+\.[0-9]+\.[0-9]+$/
      before_install: npm install -g vsce
      install: npm install --production
      script:  npm run package:generate
      deploy: &github
        provider: releases
        api_key: $GITHUB_TOKEN
        file_glob: true
        file: "*.vsix"
        skip_cleanup: true
        on:
          tags: true
    - <<: *release
      name: "Publish GitHub Pre-release"
      if: tag =~ /^v?[0-9]+\.[0-9]+\.[0-9]+.+$/
      deploy:
        <<: *github
        prerelease: true
    - &test-package
      stage: test package
      os: windows
      name: "Test package on Windows"
      if: tag =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/
      install:
        - npm install
        - npm run build
        - export PKG_VERSION=$(npm run version --silent)
        - wget https://github.com/torrentalle/vscode-perl-moose/releases/download/$TRAVIS_TAG/perl-moose-$PKG_VERSION.vsix
      script:
        - npm run test-package
    - <<: *test-package
      os: osx
      name: "Test package on OSX"
    - <<: *test-package
      os: linux
      name: "Test package on Linux"
      script:
        - xvfb-run npm run test-package
